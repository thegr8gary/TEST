<!DOCTYPE html>
<html lang="zh-Hant" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人開銷管理儀表板 v8.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f5f5f4; --bg-dark: #1f2937;
            --surface-light: #ffffff; --surface-dark: #374151;
            --text-light: #1f2937; --text-dark: #f3f4f6;
            --text-muted-light: #6b7280; --text-muted-dark: #9ca3af;
            --accent: #FFC300; --accent-hover: #E6B000;
            --highlight-bg: rgba(255, 195, 0, 0.3);
        }
        html.dark { color-scheme: dark; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-light); color: var(--text-light); }
        html.dark body { background-color: var(--bg-dark); color: var(--text-dark); }
        .surface { background-color: var(--surface-light); }
        html.dark .surface { background-color: var(--surface-dark); }
        .text-muted { color: var(--text-muted-light); }
        html.dark .text-muted { color: var(--text-muted-dark); }
        .btn-accent { background-color: var(--accent); color: #1f2937; }
        .btn-accent:hover { background-color: var(--accent-hover); }
        [contenteditable]:focus { outline: 2px solid var(--accent); box-shadow: 0 0 0 4px rgba(255, 195, 0, 0.2); border-radius: 4px; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .view-btn.active { background-color: var(--accent); color: #1f2937; }
        .view-btn { background-color: #e7e5e4; color: #374151; }
        html.dark .view-btn { background-color: #4b5563; color: #e5e7eb; }
        html.dark .view-btn.active { background-color: var(--accent); color: #1f2937; }
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .highlight {
            animation: highlight-anim 2.5s ease-out;
        }
        @keyframes highlight-anim {
            0% { background-color: var(--highlight-bg); }
            100% { background-color: transparent; }
        }
        .toast {
            animation: fade-in-out 3s ease-in-out;
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <div class="container mx-auto p-4 max-w-2xl min-h-screen">
        <header class="text-center pt-4 pb-6 relative">
             <div class="absolute top-4 right-0 flex items-center space-x-2">
                <button id="theme-toggle" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent">
                    <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            <h1 id="main-title" contenteditable="true" class="text-3xl font-bold px-10">個人開銷管理儀表板</h1>
            <p id="sub-title" contenteditable="true" class="text-muted mt-2 px-10">追蹤、分析、管理您的財務</p>
        </header>

        <div class="p-2 mb-6 rounded-full flex items-center justify-center surface shadow-md">
            <button data-view="expenses" class="view-btn w-1/2 py-2 rounded-full font-semibold transition-all duration-300">花費</button>
            <button data-view="savings" class="view-btn w-1/2 py-2 rounded-full font-semibold transition-all duration-300">儲蓄</button>
        </div>

        <main id="app-content" class="pb-32">
            <div id="expenses-view"></div>
            <div id="savings-view" class="hidden"></div>
        </main>
    </div>
    
    <div class="fixed bottom-0 left-0 right-0 p-4 flex justify-center bg-gradient-to-t from-white dark:from-gray-800 to-transparent pointer-events-none">
         <button id="add-main-btn" class="w-full max-w-xs btn-accent font-bold py-3 px-4 rounded-full flex items-center justify-center text-lg shadow-lg transform hover:scale-105 transition-transform pointer-events-auto">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span id="add-main-btn-text">新增支出</span>
        </button>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-24 right-4 z-50"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 狀態管理 (State Management) ---
        let state = {};
        const defaultState = {
            expenses: [],
            categories: ['餐飲', '交通', '購物', '娛樂', '居家', '醫療', '其他'],
            goals: [],
            recurringExpenses: [],
            budgets: {},
            ui: {
                activeView: 'expenses',
                theme: 'light',
                mainTitle: '個人開銷管理儀表板',
                subTitle: '追蹤、分析、管理您的財務',
                calendarDate: new Date().toISOString()
            }
        };

        // --- DOM 元素快取 ---
        const DOM = {
            themeToggle: document.getElementById('theme-toggle'),
            themeIconLight: document.getElementById('theme-icon-light'),
            themeIconDark: document.getElementById('theme-icon-dark'),
            mainTitleEl: document.getElementById('main-title'),
            subTitleEl: document.getElementById('sub-title'),
            viewButtons: document.querySelectorAll('.view-btn'),
            expensesView: document.getElementById('expenses-view'),
            savingsView: document.getElementById('savings-view'),
            addMainBtn: document.getElementById('add-main-btn'),
            addMainBtnText: document.getElementById('add-main-btn-text'),
            modalContainer: document.getElementById('modal-container'),
            toastContainer: document.getElementById('toast-container'),
        };

        // --- 工具函式 (Utility Functions) ---
        const formatCurrency = (amount) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const formatDateToYYYYMMDD = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const getCurrentMonthKey = () => {
            const now = new Date();
            return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        };
        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.className = 'toast bg-green-500 text-white text-sm font-semibold py-2 px-4 rounded-full shadow-lg';
            toast.textContent = message;
            DOM.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        };

        // --- 資料持久化 (Data Persistence) ---
        const saveData = () => {
            try {
                localStorage.setItem('financeTrackerDataV9', JSON.stringify(state));
            } catch (error) {
                console.error("儲存資料失敗:", error);
                alert("儲存資料時發生錯誤，您的變更可能不會被保留。");
            }
        };
        const loadData = () => {
            let data;
            try {
                data = JSON.parse(localStorage.getItem('financeTrackerDataV9'));
            } catch (error) {
                console.error("讀取本地資料失敗，將使用預設值:", error);
                data = null;
            }
            
            if (data && typeof data === 'object') {
                state = { ...defaultState, ...data, ui: { ...defaultState.ui, ...(data.ui || {}) } };
                 if (!Array.isArray(data.categories) || data.categories.length === 0) state.categories = defaultState.categories;
                 if (!Array.isArray(data.expenses)) state.expenses = defaultState.expenses;
                 if (!Array.isArray(data.goals)) state.goals = defaultState.goals;
                 if (!Array.isArray(data.recurringExpenses)) state.recurringExpenses = defaultState.recurringExpenses;
                 if (typeof data.budgets !== 'object') state.budgets = defaultState.budgets;
            } else {
                state = defaultState;
            }
        };
        
        // --- 初始化與核心渲染邏輯 ---
        const initializeAppUI = () => {
            checkAndProcessRecurringExpenses();
            applyTheme();
            applyUIText();
            switchView('expenses');
        };

        const applyTheme = () => {
            if (state.ui.theme === 'dark') {
                document.documentElement.classList.add('dark');
                DOM.themeIconLight.classList.add('hidden');
                DOM.themeIconDark.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                DOM.themeIconLight.classList.remove('hidden');
                DOM.themeIconDark.classList.add('hidden');
            }
        };

        const applyUIText = () => {
            DOM.mainTitleEl.textContent = state.ui.mainTitle;
            DOM.subTitleEl.textContent = state.ui.subTitle;
        };

        const switchView = (view) => {
            state.ui.activeView = view;
            DOM.viewButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
            DOM.expensesView.classList.toggle('hidden', view !== 'expenses');
            DOM.savingsView.classList.toggle('hidden', view !== 'savings');
            DOM.addMainBtnText.textContent = view === 'expenses' ? '新增支出' : '新增儲蓄目標';
            renderContentForView(view);
        };
        
        const renderContentForView = (view) => {
            if (view === 'expenses') renderExpensesView();
            else if (view === 'savings') renderSavingsView();
        };

        const renderCalendar = (date) => {
            const viewDate = new Date(date);
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
            let calendarHTML = `<div class="grid calendar-grid text-center font-semibold text-muted text-sm mb-2">${dayNames.map(d => `<div>${d}</div>`).join('')}</div><div class="grid calendar-grid gap-1">`;
            for (let i = 0; i < firstDayOfMonth; i++) calendarHTML += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDateToYYYYMMDD(new Date(year, month, day));
                const today = new Date();
                const isToday = formatDateToYYYYMMDD(today) === dateStr;
                const dailyExpenses = state.expenses.filter(exp => exp.date === dateStr);
                
                let expensesHTML = '';
                if (dailyExpenses.length > 0) {
                    const dailyTotal = dailyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                    expensesHTML = `<div class="mt-2 text-center text-sm font-bold text-red-500 cursor-pointer" onclick="window.app.scrollToDate('${dateStr}')">${formatCurrency(dailyTotal)}</div>`;
                }

                calendarHTML += `<div class="surface p-1.5 rounded-lg min-h-[80px] border ${isToday ? 'border-accent' : 'border-transparent'}"><div class="text-xs ${isToday ? 'font-bold' : 'text-muted'}">${day}</div>${expensesHTML}</div>`;
            }
            calendarHTML += `</div>`;
            return calendarHTML;
        };

        const renderExpensesView = () => {
            const viewDate = new Date(state.ui.calendarDate);
            const viewedMonthExpenses = state.expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getFullYear() === viewDate.getFullYear() && expDate.getMonth() === viewDate.getMonth();
            });
            const total = viewedMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const categoryTotals = viewedMonthExpenses.reduce((acc, exp) => {
                acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
                return acc;
            }, {});
            const sortedCategoryTotals = Object.entries(categoryTotals).sort(([,a],[,b]) => b-a);
            let categoryTotalsHTML = sortedCategoryTotals.length > 0 ? sortedCategoryTotals.map(([category, amount]) => `<div class="flex justify-between items-center py-2 px-4 border-b border-gray-200 dark:border-gray-600 last:border-b-0"><span>${category}</span><span class="font-semibold">${formatCurrency(amount)}</span></div>`).join('') : `<p class="text-center text-muted p-4">所選月份尚無消費</p>`;
            let expenseListHTML = state.expenses.length > 0 ? [...state.expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => {
                const noteHTML = exp.notes ? `<p class="text-xs text-muted italic pl-2">${exp.notes}</p>` : '';
                return `<div id="expense-${exp.id}" data-date="${exp.date}" class="flex items-center p-3 border-b border-gray-200 dark:border-gray-600 last:border-b-0"><div class="flex-grow"><p class="font-semibold">${exp.name}</p>${noteHTML}<p class="text-sm text-muted mt-1">${exp.date} · ${exp.category}</p></div><div class="text-right"><p class="font-bold text-lg text-red-500">${formatCurrency(exp.amount)}</p><div class="text-xs space-x-2 mt-1"><button onclick="window.app.openEditExpenseModal('${exp.id}')" class="text-blue-500 hover:text-blue-600">編輯</button><button onclick="window.app.deleteExpense('${exp.id}')" class="text-red-500 hover:text-red-600">刪除</button></div></div></div>`
            }).join('') : `<p class="text-center text-muted p-8">尚未有任何消費紀錄...</p>`;
            const calendarMonthStr = `${viewDate.getFullYear()} 年 ${viewDate.getMonth() + 1} 月`;
            const currentMonthKey = `${viewDate.getFullYear()}-${(viewDate.getMonth() + 1).toString().padStart(2, '0')}`;
            const currentBudget = state.budgets[currentMonthKey] || 0;
            const budgetRemaining = currentBudget - total;

            DOM.expensesView.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="window.app.openBudgetModal()" class="surface p-4 rounded-xl text-center shadow w-full transition-transform transform hover:scale-105"><h3 class="text-sm text-muted">本月預算餘額</h3><p class="text-2xl font-bold ${budgetRemaining >= 0 ? 'text-green-600' : 'text-red-500'}">${formatCurrency(budgetRemaining)}</p></button>
                    <div class="surface p-4 rounded-xl text-center shadow"><h3 class="text-sm text-muted">本月總支出</h3><p class="text-2xl font-bold text-red-500">${formatCurrency(total)}</p></div>
                </div>
                <h2 class="text-xl font-bold mb-2 px-2">本月類別總計</h2><div class="surface rounded-xl shadow overflow-hidden mb-6">${categoryTotalsHTML}</div>
                <div class="flex justify-between items-center mb-2 px-2"><h2 class="text-xl font-bold">消費月曆</h2></div>
                <div class="surface rounded-xl shadow p-4 mb-6"><div class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">&lt;</button><h3 class="font-bold text-lg">${calendarMonthStr}</h3><button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">&gt;</button></div><div id="calendar-container">${renderCalendar(state.ui.calendarDate)}</div></div>
                <div class="flex justify-between items-center mb-2 px-2"><h2 class="text-xl font-bold">支出紀錄</h2></div>
                <div class="surface rounded-xl shadow overflow-hidden mb-6">
                    ${expenseListHTML}
                    <div class="p-2 flex justify-end"><button id="export-btn" class="text-sm btn-accent py-1 px-3 rounded-lg font-semibold">匯出 CSV</button></div>
                </div>
            `;
            document.getElementById('export-btn').addEventListener('click', window.app.exportCsv);
            document.getElementById('prev-month-btn').addEventListener('click', () => window.app.changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => window.app.changeMonth(1));
        };

        const renderSavingsView = () => {
            const totalSaved = state.goals.reduce((sum, goal) => sum + (goal.saved || 0), 0);
            let goalsHTML = state.goals.length > 0 ? state.goals.map(goal => {
                const percentage = goal.target > 0 ? Math.max(0, Math.min(100, (goal.saved / goal.target) * 100)) : 0;
                return `<div class="p-4 border-b border-gray-200 dark:border-gray-600 last:border-b-0"><div class="flex justify-between items-center mb-2"><span class="font-bold text-lg">${goal.name}</span><div class="text-xs space-x-2"><button onclick="window.app.openEditGoalModal('${goal.id}')" class="text-blue-500 hover:text-blue-600">編輯</button><button onclick="window.app.deleteGoal('${goal.id}')" class="text-red-500 hover:text-red-600">刪除</button></div></div><div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-4"><div class="h-4 rounded-full" style="width: ${percentage}%; background-color: var(--accent);"></div></div><div class="flex justify-between text-xs mt-1 text-muted"><span>${percentage.toFixed(1)}%</span><span>${formatCurrency(goal.saved)} / ${formatCurrency(goal.target)}</span></div></div>`
            }).join('') : `<p class="text-center text-muted p-8">尚未設定儲蓄目標...</p>`;
            DOM.savingsView.innerHTML = `
                <div class="surface p-4 rounded-xl text-center shadow mb-6">
                    <h3 class="text-sm text-muted">總存款</h3>
                    <p class="text-2xl font-bold text-green-600">${formatCurrency(totalSaved)}</p>
                </div>
                <h2 class="text-xl font-bold mb-2 px-2">儲蓄目標</h2><div class="surface rounded-xl shadow overflow-hidden">${goalsHTML}</div>`;
        };
        
        const openModal = (title, contentHTML, onSubmit, onOpened) => {
            DOM.modalContainer.innerHTML = `<div id="modal-backdrop" class="fixed inset-0 z-40 modal-backdrop"></div><div id="modal-dialog" class="fixed z-50 bottom-0 left-0 right-0 surface rounded-t-2xl p-6 shadow-lg transform translate-y-full transition-transform duration-300 max-h-[80vh] flex flex-col"><h3 class="text-xl font-bold mb-4 flex-shrink-0">${title}</h3><div id="modal-content-wrapper" class="flex-grow overflow-y-auto">${contentHTML}</div></div>`;
            const backdrop = document.getElementById('modal-backdrop');
            const dialog = document.getElementById('modal-dialog');
            const form = dialog.querySelector('form');
            backdrop.onclick = () => closeModal(dialog, backdrop);
            if (form && onSubmit) { form.onsubmit = (e) => { e.preventDefault(); onSubmit(new FormData(form)); closeModal(dialog, backdrop); }; }
            requestAnimationFrame(() => {
                dialog.classList.remove('translate-y-full');
                if (onOpened) onOpened(dialog);
            });
        };

        const closeModal = (dialog, backdrop) => {
            dialog.classList.add('translate-y-full');
            backdrop.classList.add('opacity-0');
            setTimeout(() => DOM.modalContainer.innerHTML = '', 300);
        };

        const getExpenseFormHTML = (expense = {}) => {
            const isNew = !expense.id;
            const dateValue = expense.date || formatDateToYYYYMMDD(new Date());

            const categoryOptions = state.categories.map(cat => `<option value="${cat}" ${expense.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
            
            const dateDisplayHTML = isNew ? `
                <div id="date-display" class="flex items-center justify-between mt-1 p-2 rounded-lg">
                    <span class="text-gray-700 dark:text-gray-200">${dateValue} (今天)</span>
                    <button type="button" id="change-date-btn" class="text-xs font-semibold" style="color: var(--accent);">修改</button>
                </div>
            ` : '';

            return `<form id="modal-form"><div class="space-y-4"><input type="hidden" name="id" value="${expense.id || ''}"><div><label class="text-sm text-muted">品項</label><input type="text" name="name" value="${expense.name || ''}" required class="w-full mt-1 p-2 rounded-lg border bg-transparent"></div><div><label class="text-sm text-muted">金額</label><input type="number" name="amount" value="${expense.amount || ''}" min="0" required class="w-full mt-1 p-2 rounded-lg border bg-transparent"></div><div><div class="flex justify-between items-center"><label class="text-sm text-muted">類別</label><button type="button" onclick="window.app.openManageCategoriesModal()" class="text-xs font-semibold" style="color: var(--accent);">管理類別</button></div><select name="category" class="w-full mt-1 p-2 rounded-lg border bg-transparent">${categoryOptions}</select></div>
            <div>
                <label class="text-sm text-muted">日期</label>
                ${dateDisplayHTML}
                <input type="date" name="date" value="${dateValue}" required class="w-full mt-1 p-2 rounded-lg border bg-transparent ${isNew ? 'hidden' : ''}">
            </div>
            <div><label class="text-sm text-muted">備註 (選填)</label><textarea name="notes" class="w-full mt-1 p-2 rounded-lg border bg-transparent" rows="2">${expense.notes || ''}</textarea></div></div>
            <div class="mt-6 flex flex-col items-center space-y-4">
                <button type="submit" class="w-full max-w-xs btn-accent font-bold py-3 px-4 rounded-full flex items-center justify-center text-lg">儲存</button>
                <button type="button" onclick="window.app.switchToRecurringManagement()" class="text-sm font-semibold text-muted hover:text-accent">管理週期性支出</button>
            </div>
            </form>`;
        };
        
        const getGoalFormHTML = (goal = {}) => `<form id="modal-form"><div class="space-y-4"><input type="hidden" name="id" value="${goal.id || ''}"><div><label class="text-sm text-muted">目標名稱</label><input type="text" name="name" value="${goal.name || ''}" required class="w-full mt-1 p-2 rounded-lg border bg-transparent"></div><div><label class="text-sm text-muted">目標金額</label><input type="number" name="target" value="${goal.target || ''}" min="0" required class="w-full mt-1 p-2 rounded-lg border bg-transparent"></div><div><label class="text-sm text-muted">目前已存</label><input type="number" name="saved" value="${goal.saved || ''}" min="0" required class="w-full mt-1 p-2 rounded-lg border bg-transparent"></div></div><div class="mt-6 flex justify-end"><button type="submit" class="btn-accent font-bold py-2 px-6 rounded-lg">儲存</button></div></form>`;
        
        const getRecurringExpenseFormHTML = (item = {}) => {
            const categoryOptions = state.categories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
            return `<form id="modal-form"><div class="space-y-4">
                <input type="hidden" name="id" value="${item.id || ''}">
                <div><label class="text-sm text-muted">品項</label><input type="text" name="name" value="${item.name || ''}" required class="w-full mt-1 p-2 rounded-lg border bg-transparent"></div>
                <div><label class="text-sm text-muted">金額</label><input type="number" name="amount" value="${item.amount || ''}" min="0" required class="w-full mt-1 p-2 rounded-lg border bg-transparent"></div>
                <div><label class="text-sm text-muted">類別</label><select name="category" class="w-full mt-1 p-2 rounded-lg border bg-transparent">${categoryOptions}</select></div>
                <div><label class="text-sm text-muted">每月執行日期 (1-28)</label><input type="number" name="day" value="${item.day || ''}" min="1" max="28" required class="w-full mt-1 p-2 rounded-lg border bg-transparent"></div>
            </div><div class="mt-6 flex justify-center"><button type="submit" class="w-full max-w-xs btn-accent font-bold py-3 px-4 rounded-full">儲存</button></div></form>`;
        };

        const checkAndProcessRecurringExpenses = () => {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            let processedCount = 0;

            state.recurringExpenses.forEach(item => {
                const lastProcessed = item.lastProcessed ? new Date(item.lastProcessed) : null;
                const lastProcessedYear = lastProcessed ? lastProcessed.getFullYear() : null;
                const lastProcessedMonth = lastProcessed ? lastProcessed.getMonth() : null;

                if (lastProcessedYear !== currentYear || lastProcessedMonth !== currentMonth) {
                    if (today.getDate() >= item.day) {
                        const dateStr = formatDateToYYYYMMDD(new Date(currentYear, currentMonth, item.day));
                        const newExpense = {
                            id: generateId(),
                            recurringId: item.id,
                            name: item.name,
                            amount: item.amount,
                            category: item.category,
                            date: dateStr,
                            notes: `週期性支出: ${item.name}`
                        };
                        state.expenses.push(newExpense);
                        item.lastProcessed = new Date().toISOString();
                        processedCount++;
                    }
                }
            });

            if (processedCount > 0) {
                showToast(`已自動新增 ${processedCount} 筆週期性支出`);
                saveData();
            }
        };

        window.app = {
            openEditExpenseModal: (id) => {
                const expense = state.expenses.find(e => e.id === id);
                openModal('編輯支出', getExpenseFormHTML(expense), (formData) => {
                    const index = state.expenses.findIndex(e => e.id === id);
                    state.expenses[index] = { ...expense, name: formData.get('name'), amount: parseFloat(formData.get('amount')), category: formData.get('category'), date: formData.get('date'), notes: formData.get('notes') };
                    saveData();
                    renderContentForView('expenses');
                });
            },
            deleteExpense: (id) => {
                if (confirm('確定要刪除這筆紀錄嗎？')) {
                    state.expenses = state.expenses.filter(e => e.id !== id);
                    saveData();
                    renderContentForView('expenses');
                }
            },
            openEditGoalModal: (id) => {
                const goal = state.goals.find(g => g.id === id);
                openModal(id ? '編輯儲蓄目標' : '新增儲蓄目標', getGoalFormHTML(goal), (formData) => {
                    const goalId = formData.get('id');
                    const goalData = { name: formData.get('name'), target: parseFloat(formData.get('target')), saved: parseFloat(formData.get('saved')) };
                    if (goalId) {
                        const index = state.goals.findIndex(g => g.id === goalId);
                        state.goals[index] = { ...state.goals[index], ...goalData };
                    } else {
                        state.goals.push({ id: generateId(), ...goalData });
                    }
                    saveData();
                    renderContentForView('savings');
                });
            },
            deleteGoal: (id) => {
                 if (confirm('確定要刪除這個儲蓄目標嗎？')) {
                    state.goals = state.goals.filter(g => g.id !== id);
                    saveData();
                    renderContentForView('savings');
                }
            },
            switchToRecurringManagement: () => {
                const dialog = document.getElementById('modal-dialog');
                const backdrop = document.getElementById('modal-backdrop');
                if (dialog && backdrop) {
                    closeModal(dialog, backdrop);
                    setTimeout(() => {
                        window.app.openManageRecurringExpensesModal();
                    }, 350);
                }
            },
            openManageRecurringExpensesModal: () => {
                const renderList = () => {
                    const totalRecurring = state.recurringExpenses.reduce((sum, item) => sum + item.amount, 0);
                    const listHTML = state.recurringExpenses.map(item => `
                        <div class="flex items-center p-3 border-b border-gray-200 dark:border-gray-600 last:border-b-0">
                            <div class="flex-grow">
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-muted">每月 ${item.day} 日 · ${item.category}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg text-blue-500">${formatCurrency(item.amount)}</p>
                                <div class="text-xs space-x-2 mt-1">
                                    <button onclick="window.app.openAddRecurringExpenseModal('${item.id}')" class="text-blue-500 hover:text-blue-600">編輯</button>
                                    <button onclick="window.app.deleteRecurringExpense('${item.id}')" class="text-red-500 hover:text-red-600">刪除</button>
                                </div>
                            </div>
                        </div>`).join('') || `<p class="text-center text-muted p-4">無週期性支出項目</p>`;
                    
                    return `
                        <div class="surface p-4 rounded-xl text-center shadow mb-4">
                            <h3 class="text-sm text-muted">每月固定總支出</h3>
                            <p class="text-2xl font-bold text-blue-500">${formatCurrency(totalRecurring)}</p>
                        </div>
                        ${listHTML}
                    `;
                };

                const contentHTML = `
                    <div class="flex justify-between items-center mb-2">
                         <h2 class="text-lg font-bold">已設定項目</h2>
                         <button onclick="window.app.openAddRecurringExpenseModal(null)" class="text-sm btn-accent py-1 px-3 rounded-lg font-semibold">⊕ 新增</button>
                    </div>
                    <div class="surface rounded-xl shadow overflow-hidden">${renderList()}</div>
                    <div class="mt-6 flex justify-center">
                        <button type="button" onclick="document.getElementById('modal-backdrop').click()" class="w-full max-w-xs btn-accent font-bold py-3 px-4 rounded-full">完成</button>
                    </div>
                `;
                openModal('管理週期性支出', contentHTML, null);
            },
            openAddRecurringExpenseModal: (id = null) => {
                const item = id ? state.recurringExpenses.find(i => i.id === id) : {};
                openModal(id ? '編輯週期性支出' : '新增週期性支出', getRecurringExpenseFormHTML(item), (formData) => {
                    const recurringId = formData.get('id') || generateId();
                    const newItem = {
                        id: recurringId,
                        name: formData.get('name'),
                        amount: parseFloat(formData.get('amount')),
                        category: formData.get('category'),
                        day: parseInt(formData.get('day')),
                        lastProcessed: id ? item.lastProcessed : null
                    };
                    const index = state.recurringExpenses.findIndex(i => i.id === recurringId);
                    if (index > -1) {
                        state.recurringExpenses[index] = newItem;
                    } else {
                        state.recurringExpenses.push(newItem);
                    }
                    
                    checkAndProcessRecurringExpenses();
                    saveData();
                    renderContentForView('expenses');
                    window.app.switchToRecurringManagement();
                });
            },
            deleteRecurringExpense: (id) => {
                if (confirm('確定要刪除這個週期性支出項目嗎？')) {
                    state.recurringExpenses = state.recurringExpenses.filter(i => i.id !== id);
                    saveData();
                    window.app.openManageRecurringExpensesModal();
                }
            },
            openManageCategoriesModal: () => {
                const renderCategoryList = () => state.categories.map(cat => `<li class="flex justify-between items-center p-2 border-b border-gray-200 dark:border-gray-600"><input type="text" value="${cat}" onchange="window.app.updateCategory('${cat}', this.value)" class="border-b-2 border-transparent focus:border-accent outline-none bg-transparent flex-grow"><button onclick="window.app.deleteCategory('${cat}')" class="text-red-500 hover:text-red-700 ml-4 text-sm">刪除</button></li>`).join('');
                const contentHTML = `<ul id="category-list-ui" class="mb-4 max-h-60 overflow-y-auto">${renderCategoryList()}</ul><form id="add-category-form" class="flex space-x-2"><input type="text" id="new-category-name" placeholder="新增類別名稱" required class="flex-grow border p-2 rounded-lg bg-transparent"><button type="submit" class="btn-accent text-black font-semibold px-4 py-2 rounded-lg">新增</button></form>`;
                openModal('管理類別', contentHTML, null);
                document.getElementById('add-category-form').onsubmit = (e) => {
                    e.preventDefault();
                    const newCatName = document.getElementById('new-category-name').value.trim();
                    if (newCatName && !state.categories.includes(newCatName)) {
                        state.categories.push(newCatName);
                        saveData();
                        document.getElementById('category-list-ui').innerHTML = renderCategoryList();
                        e.target.reset();
                    }
                };
            },
            updateCategory: (oldName, newName) => {
                newName = newName.trim();
                if (!newName || (state.categories.includes(newName) && oldName !== newName)) { alert('類別名稱不可為空或重複！'); window.app.openManageCategoriesModal(); return; }
                const index = state.categories.indexOf(oldName);
                if (index > -1) { state.categories[index] = newName; state.expenses.forEach(exp => { if (exp.category === oldName) exp.category = newName; }); saveData(); }
            },
            deleteCategory: (name) => {
                if (state.categories.length <= 1) { alert('至少需保留一個類別。'); return; }
                if (confirm(`確定要刪除「${name}」類別嗎？\n使用此類別的紀錄將會被歸類到「其他」。`)) {
                    state.categories = state.categories.filter(cat => cat !== name);
                    if (!state.categories.includes('其他')) state.categories.push('其他');
                    state.expenses.forEach(exp => { if (exp.category === name) exp.category = '其他'; });
                    saveData();
                    document.getElementById('category-list-ui').innerHTML = state.categories.map(cat => `<li class="flex justify-between items-center p-2 border-b"><input type="text" value="${cat}" onchange="window.app.updateCategory('${cat}', this.value)" class="..."><button onclick="window.app.deleteCategory('${cat}')" class="...">刪除</button></li>`).join('');
                }
            },
            exportCsv: () => {
                if (state.expenses.length === 0) { alert('沒有資料可以匯出。'); return; }
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "日期,品項,類別,金額,備註\n";
                state.expenses.forEach(exp => { const notes = exp.notes ? `"${exp.notes.replace(/"/g, '""')}"` : ''; csvContent += [exp.date, `"${exp.name.replace(/"/g, '""')}"`, exp.category, exp.amount, notes].join(",") + "\n"; });
                const link = document.createElement("a");
                link.href = encodeURI(csvContent);
                link.download = `我的記帳紀錄_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            },
            changeMonth: (direction) => {
                const currentDate = new Date(state.ui.calendarDate);
                currentDate.setMonth(currentDate.getMonth() + direction);
                state.ui.calendarDate = currentDate.toISOString();
                saveData();
                renderContentForView('expenses');
            },
            scrollToDate: (date) => {
                const allElements = document.querySelectorAll(`[data-date="${date}"]`);
                if (allElements.length > 0) {
                    const firstElement = allElements[0];
                    firstElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    allElements.forEach(el => {
                        el.classList.add('highlight');
                        setTimeout(() => el.classList.remove('highlight'), 2500);
                    });
                }
            },
            openBudgetModal: () => {
                const currentMonthKey = getCurrentMonthKey();
                const currentBudget = state.budgets[currentMonthKey] || '';
                const contentHTML = `
                    <form id="modal-form">
                        <div class="space-y-2">
                            <label for="budget-amount" class="text-sm text-muted">設定本月總預算</label>
                            <input type="number" id="budget-amount" name="budget" value="${currentBudget}" min="0" required class="w-full mt-1 p-2 rounded-lg border bg-transparent">
                        </div>
                        <div class="mt-6 flex justify-center">
                            <button type="submit" class="w-full max-w-xs btn-accent font-bold py-3 px-4 rounded-full">儲存預算</button>
                        </div>
                    </form>
                `;
                openModal('設定預算', contentHTML, (formData) => {
                    const newBudget = parseFloat(formData.get('budget'));
                    if (!isNaN(newBudget) && newBudget >= 0) {
                        state.budgets[currentMonthKey] = newBudget;
                        saveData();
                        renderContentForView('expenses');
                    }
                });
            }
        };

        // Initialize App
        loadData();
        initializeAppUI();

        // Event Listeners
        DOM.themeToggle.addEventListener('click', () => { state.ui.theme = state.ui.theme === 'light' ? 'dark' : 'light'; applyTheme(); saveData(); });
        DOM.mainTitleEl.addEventListener('blur', () => { state.ui.mainTitle = DOM.mainTitleEl.textContent; saveData(); });
        DOM.subTitleEl.addEventListener('blur', () => { state.ui.subTitle = DOM.subTitleEl.textContent; saveData(); });
        DOM.viewButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
        DOM.addMainBtn.addEventListener('click', () => {
            if (state.ui.activeView === 'expenses') {
                openModal('新增支出', getExpenseFormHTML(), (formData) => {
                    const newExpense = { id: generateId(), name: formData.get('name'), amount: parseFloat(formData.get('amount')), category: formData.get('category'), date: formData.get('date'), notes: formData.get('notes') };
                    state.expenses.push(newExpense);
                    saveData();
                    renderContentForView('expenses');
                }, (dialog) => { // onOpened callback
                    const changeDateBtn = dialog.querySelector('#change-date-btn');
                    const dateInput = dialog.querySelector('input[name="date"]');
                    const dateDisplay = dialog.querySelector('#date-display');
                    if (changeDateBtn) {
                        changeDateBtn.addEventListener('click', () => {
                            dateDisplay.classList.add('hidden');
                            dateInput.classList.remove('hidden');
                            dateInput.focus();
                        });
                    }
                });
            } else {
                window.app.openEditGoalModal(null);
            }
        });
        
    });
    </script>
</body>
</html>
